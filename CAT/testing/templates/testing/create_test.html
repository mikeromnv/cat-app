{% extends 'base.html' %}
{% load static %}

{% block title %}Создание теста{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tests/create_test.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5 fade-in" style="max-width: 850px;">

    <div class="card shadow-sm border-0">
        <div class="card-body p-4">

            <h2 class="text-center mb-4 fw-bold">Создание теста</h2>

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            <form method="post" id="createTestForm">
                {% csrf_token %}

                <div class="mb-4">
                    <label for="test_name" class="form-label fw-semibold">Название теста</label>
                    <input type="text" name="test_name" id="test_name"
                           class="form-control form-control-lg"
                           value="{{ test_name|default:'' }}" required>
                </div>

                <div class="mb-4">
                    <label for="topic" class="form-label fw-semibold">Выберите дисциплину</label>
                    <select name="topic" id="topic" class="form-select form-select-lg">
                        <option value="">-- выберите дисциплину --</option>
                        {% for topic in topics %}
                            <option value="{{ topic.topic_id }}"
                                {% if selected_topic and selected_topic.topic_id == topic.topic_id %}selected{% endif %}>
                                {{ topic.topic_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit" name="save_test"
                        class="btn btn-primary btn-lg w-100 shadow-sm">
                    Сохранить тест и перейти к добавлению вопросов
                </button>
            </form>

            {% if test_created and test %}
            <div class="alert alert-success mt-4 shadow-sm">
                <h5 class="fw-bold">Тест "{{ test.name }}" создан успешно!</h5>
                <p>Теперь вы можете добавить вопросы к тесту.</p>
                <div class="mt-3 d-flex gap-2">
                    <a href="{% url 'edit_test' test_id=test.test_id %}"
                       class="btn btn-success flex-fill">Добавить вопросы</a>
                    <a href="{% url 'create_test' %}"
                       class="btn btn-outline-secondary flex-fill">Создать новый</a>
                </div>
            </div>
            {% endif %}

            {% if selected_topic and not test_created %}
            <hr class="my-4">

            <h4 class="fw-semibold">Доступные вопросы по теме "{{ selected_topic.topic_name }}"</h4>

            {% if questions %}
            <div class="list-group mt-3">
                {% for question in questions %}
                <div class="list-group-item d-flex justify-content-between align-items-center fade-in">
                    <div>
                        <strong>{{ question.text_question }}</strong><br>
                        <small class="text-muted">
                            Сложность: {{ question.difficulty }} |
                            Автор: {{ question.author.username }}
                        </small>
                    </div>
                    <span class="badge bg-secondary">Доступен</span>
                </div>
                {% endfor %}
            </div>

            <p class="text-muted mt-2">
                <small>Эти вопросы будут доступны после создания теста.</small>
            </p>

            {% else %}
            <div class="alert alert-info shadow-sm mt-3">
                <p class="mb-1">Нет вопросов по теме "{{ selected_topic.topic_name }}".</p>
                <p class="mb-0">После создания теста вы сможете добавить новые.</p>
            </div>
            {% endif %}

            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
